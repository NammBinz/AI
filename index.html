from flask import Flask, render_template, Response, request, jsonify
import cv2
import pandas as pd
from ultralytics import YOLO
import easyocr
import datetime
import os
import time
import threading

app = Flask(__name__)

# --- CẤU HÌNH ---
MODEL_PATH = 'my_license_plate_model.pt'
CSV_FILE = 'lich_su_xe.csv'
PARKING_SLOTS = 10  # Tổng số chỗ đỗ xe giả lập

# Biến toàn cục
parking_status = ["Trống"] * PARKING_SLOTS # Trạng thái từng chỗ (Trống/Có xe)
last_recognized = ""
camera_source = 0 # Mặc định là webcam máy tính. Sẽ đổi thành URL nếu dùng điện thoại.

# 1. Load Model (Chỉ load 1 lần)
print("⏳ Đang tải AI (YOLO & EasyOCR)...")
try:
    model = YOLO(MODEL_PATH)
    reader = easyocr.Reader(['en'], gpu=False)
    print("✅ AI đã sẵn sàng!")
except:
    print("❌ Lỗi: Không tìm thấy model. Hãy copy file .pt vào cùng thư mục.")
    model = None

# 2. Quản lý File CSV
if not os.path.exists(CSV_FILE):
    df = pd.DataFrame(columns=['ThoiGian', 'BienSo', 'Loai', 'TrangThai'])
    df.to_csv(CSV_FILE, index=False)

# --- CÁC HÀM XỬ LÝ ---
def save_log(plate, method="Tự động", status="Vào"):
    """Lưu lịch sử vào CSV"""
    now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # Logic giả lập: Nếu biển số đã có trong bãi -> Xe ra, ngược lại -> Xe vào
    # Ở đây để đơn giản ta cứ ghi nhận là "Vào/Ra" luân phiên hoặc mặc định
    
    new_data = pd.DataFrame([[now, plate, method, status]], columns=['ThoiGian', 'BienSo', 'Loai', 'TrangThai'])
    new_data.to_csv(CSV_FILE, mode='a', header=False, index=False)
    
    # Cập nhật trạng thái bãi xe (Logic giả lập ngẫu nhiên để demo giao diện)
    # Trong thực tế cần sensor hoặc camera từng ô
    import random
    empty_slots = [i for i, x in enumerate(parking_status) if x == "Trống"]
    if empty_slots and status == "Vào":
        slot = random.choice(empty_slots)
        parking_status[slot] = plate
    elif status == "Ra":
         # Tìm xe để cho ra
         for i, p in enumerate(parking_status):
             if p == plate:
                 parking_status[i] = "Trống"

def process_frame(frame):
    global last_recognized
    if model is None: return frame
    
    results = model.predict(frame, conf=0.5, verbose=False)
    for result in results:
        for box in result.boxes:
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            # Vẽ khung
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
            
            # OCR
            h, w, _ = frame.shape
            if 0 <= y1 < y2 <= h and 0 <= x1 < x2 <= w:
                crop = frame[y1:y2, x1:x2]
                try:
                    gray = cv2.cvtColor(crop, cv2.COLOR_BGR2GRAY)
                    ocr = reader.readtext(gray, detail=0)
                    text = "".join([t for t in ocr if t.isalnum()]).upper()
                    
                    if len(text) > 3:
                        cv2.putText(frame, text, (x1, y1-10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, (0, 255, 0), 2)
                        
                        # Logic chống spam: Chỉ lưu nếu khác biển số vừa nhận diện 5s trước
                        if text != last_recognized:
                            save_log(text, method="Camera AI", status="Vào")
                            last_recognized = text
                except: pass
    return frame

def generate_frames():
    # Mở camera (0 là webcam, hoặc điền URL IP Webcam của điện thoại vào đây)
    # Ví dụ: cap = cv2.VideoCapture('http://192.168.1.5:8080/video')
    cap = cv2.VideoCapture(camera_source) 
    
    while True:
        success, frame = cap.read()
        if not success:
            break
        
        # Resize nhẹ để chạy nhanh hơn
        frame = cv2.resize(frame, (800, 600))
        frame = process_frame(frame)
        
        ret, buffer = cv2.imencode('.jpg', frame)
        frame = buffer.tobytes()
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')

# --- ROUTES (ĐƯỜNG DẪN WEB) ---
@app.route('/')
def index():
    return render_template('dashboard.html')

@app.route('/video_feed')
def video_feed():
    return Response(generate_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/api/stats')
def get_stats():
    """API trả về dữ liệu cho Dashboard cập nhật tự động"""
    total = PARKING_SLOTS
    occupied = len([x for x in parking_status if x != "Trống"])
    available = total - occupied
    
    # Đọc lịch sử
    if os.path.exists(CSV_FILE):
        df = pd.read_csv(CSV_FILE)
        history = df.tail(10).iloc[::-1].to_dict(orient='records')
    else:
        history = []
        
    return jsonify({
        'total': total,
        'occupied': occupied,
        'available': available,
        'slots': parking_status,
        'history': history
    })

@app.route('/manual_entry', methods=['POST'])
def manual_entry():
    """Xử lý nhập tay từ giao diện"""
    plate = request.form.get('plate_number')
    action = request.form.get('action') # Vào hoặc Ra
    if plate:
        save_log(plate.upper(), method="Thủ công", status=action)
        return jsonify({'status': 'success', 'message': f'Đã thêm xe {plate}'})
    return jsonify({'status': 'error', 'message': 'Lỗi nhập liệu'})

# API để đổi nguồn Camera (Từ Webcam sang ĐT hoặc ngược lại)
@app.route('/set_camera', methods=['POST'])
def set_camera():
    global camera_source
    url = request.form.get('camera_url')
    if url == '0' or url == '':
        camera_source = 0
    else:
        camera_source = url
    return jsonify({'status': 'success', 'source': camera_source})

if __name__ == '__main__':
    # host='0.0.0.0' để các thiết bị khác trong cùng Wifi (như điện thoại) truy cập được
    app.run(host='0.0.0.0', port=5000, debug=True)